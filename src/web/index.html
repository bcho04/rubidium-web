<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Rubidium</title>
    <meta name="description" content="Rubidium">
    <meta name="author" content="SitePoint">

    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.1/dist/Chart.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

    <div class="chart-container" style="position: static; height:20vh; width:40vw">
        <canvas id="myChart"></canvas>
        <canvas id="myChart2"></canvas>
        <canvas id="myChart3"></canvas>
    </div>
    <script>
        var ctx = document.getElementById('myChart');
        var ctx2 = document.getElementById('myChart2');
        var ctx3 = document.getElementById('myChart3');

        let url = "http://10.1.129.133:8080/filter";
        let query = {
            "filter": {
                "$or": [{"queueId": 400}, {"queueId": 420}, {"queueId": 430}, {"queueId": 440}]
            }, "select": {
                "gpm": "participants.stats.deaths", 
                "role": "participants.timeline.role",
                "win": "participants.stats.win",
                "name": "participantIdentities.player.summonerName"
            }
        };
        let spacing = 1;
        let barsize = 1;
        let bars = 30;

        $.ajax({
            type: "POST",
            url: url,
            data: query,
            success: function(data, status) {
                var sname = prompt("Summoner name:", "");
                var rolename = prompt("Role name:", "");
                let toplot = [];
                var map_2 = data.data.map(function(e, i) {
                    return [e.gpm, e.win, e.name, e.role];
                });
                
                var dpts = map_2[0].map((col, i) => map_2.map(row => row[i]));
                dpts[0] = dpts[0].flat();
                dpts[1] = dpts[1].flat();
                dpts[2] = dpts[2].flat();
                dpts[3] = dpts[3].flat();
                dpts[1] = dpts[1].map(x => x ? 1 : 0);
                dpts = dpts[0].map(function(e, i) {
                    return [e, dpts[1][i], dpts[2][i], dpts[3][i]];
                });

                console.log(dpts);

                var scatter_dt = [];
                dpts.forEach((pt) => {
                    if(pt[0] != null && pt[1] != null) {
                        scatter_dt.push({x: pt[0].toFixed(1), y:pt[1].toFixed(1)});
                    }
                })

                var win_hist_dt = new Array(bars).fill(0);
                dpts.forEach((pt) => {
                    if(pt[1] == 1 && pt[0] != null && (sname == "" || pt[2] == sname) && (rolename == "" || pt[3] == rolename)) win_hist_dt[Math.floor(pt[0]/barsize)] += 1;
                });

                var lose_hist_dt = new Array(bars).fill(0);
                dpts.forEach((pt) => {
                    if(pt[1] == 0 && pt[0] != null && (sname == "" || pt[2] == sname) && (rolename == "" || pt[3] == rolename)) lose_hist_dt[Math.floor(pt[0]/barsize)] += 1;
                });

                var myChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: "gpm vs win",
                            data: scatter_dt
                        }]
                    },
                    options: {
                        scales: {
                            xAxes: [{
                                type: 'linear',
                                position: 'bottom',
                                ticks: {
                                    beginAtZero: true
                                }
                            }]
                        }
                    }
                });

                var myChart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        datasets: [{
                            label: "gpm win",
                            barPercentage: 1,
                            categoryPercentage: 1,
                            data: win_hist_dt,
                            backgroundColor: 'rgba(0,0,255,0.2)',
                            order: 1
                        }],
                        labels: [...Array(bars).keys()].map(x => (x*spacing).toString())
                    }, options: {
                        scales: {
                            xAxes: [{ stacked: true }]
                        }
                    }
                });

                var myChart3 = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        datasets: [{
                            label: "gpm lose",
                            barPercentage: 1,
                            categoryPercentage: 1,
                            data: lose_hist_dt,
                            backgroundColor: 'rgba(255,0,0,0.2)',
                            order: 1
                        }],
                        labels: [...Array(bars).keys()].map(x => (x*spacing).toString())
                    }, options: {
                        scales: {
                            xAxes: [{ stacked: true }]
                        }
                    }
                });
            },
            error: function(error) {
                console.log("error");
            }
        });
    </script>
</body>
</html>